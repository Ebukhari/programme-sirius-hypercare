<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programme Sirius - Hypercare Support</title>
    <style>
        :root {
            --color-critical: #c01530;
            --color-high: #e67a1f;
            --color-medium: #f4c430;
            --color-low: #2080b0;
            --color-closed: #207e6b;
            --color-bg: #0f2942;
            --color-surface: #1a3f5c;
            --color-text: #f5f5f5;
            --color-border: rgba(255, 255, 255, 0.1);
            --color-primary: #32b8c6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background: var(--color-bg); color: var(--color-text); line-height: 1.6; }
        
        /* Login Screen */
        .login-container { display: flex; align-items: center; justify-content: center; width: 100%; height: 100vh; background: linear-gradient(135deg, var(--color-bg) 0%, var(--color-surface) 100%); }
        .login-box { background: var(--color-surface); border: 2px solid var(--color-primary); border-radius: 8px; padding: 40px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
        .login-box h1 { color: var(--color-primary); margin-bottom: 10px; font-size: 28px; }
        .login-box p { color: #aaa; margin-bottom: 30px; font-size: 14px; }
        .login-form { display: flex; flex-direction: column; gap: 15px; }
        .form-group-login { display: flex; flex-direction: column; }
        .form-group-login label { color: #ddd; font-weight: 600; margin-bottom: 8px; font-size: 13px; }
        .form-group-login input { padding: 10px 15px; border: 1px solid var(--color-border); border-radius: 4px; background: var(--color-bg); color: var(--color-text); font-size: 14px; }
        .form-group-login input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 8px rgba(50, 184, 198, 0.3); }
        .login-btn { padding: 12px; background: var(--color-primary); color: var(--color-bg); border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s ease; }
        .login-btn:hover { background: #2a9fb0; transform: translateY(-2px); }
        .login-error { color: var(--color-critical); font-size: 13px; margin-top: 10px; }
        .hidden { display: none !important; }
        
        header { background: linear-gradient(135deg, var(--color-bg) 0%, var(--color-surface) 100%); padding: 20px; border-bottom: 2px solid var(--color-primary); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-left h1 { font-size: 24px; color: var(--color-primary); margin-bottom: 5px; }
        .header-left p { font-size: 12px; color: #aaa; margin: 0; }
        .header-right { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .status-indicator { display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: rgba(255, 255, 255, 0.05); border-radius: 4px; font-size: 12px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite; background: #4ade80; }
        .user-info { display: flex; align-items: center; gap: 10px; padding: 5px 10px; background: rgba(50, 184, 198, 0.1); border-radius: 4px; font-size: 12px; }
        .logout-btn { padding: 6px 12px; background: var(--color-critical); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s ease; }
        .logout-btn:hover { background: #a01028; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .last-update { font-size: 11px; color: #999; }
        .container { padding: 20px; max-width: 1600px; margin: 0 auto; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        input, select, button { padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 4px; background: var(--color-surface); color: var(--color-text); font-size: 13px; cursor: pointer; }
        input::placeholder { color: #999; }
        input:focus, select:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 8px rgba(50, 184, 198, 0.2); }
        button { background: var(--color-primary); color: var(--color-bg); border: none; font-weight: 600; transition: all 0.3s ease; }
        button:hover { background: #2a9fb0; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(50, 184, 198, 0.3); }
        button.secondary { background: transparent; color: var(--color-primary); border: 1px solid var(--color-primary); }
        button.secondary:hover { background: rgba(50, 184, 198, 0.1); }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--color-surface); border: 1px solid var(--color-border); border-left: 4px solid; border-radius: 4px; padding: 15px; text-align: center; }
        .stat-card.total { border-left-color: #7c3aed; }
        .stat-card.critical { border-left-color: var(--color-critical); }
        .stat-card.high { border-left-color: var(--color-high); }
        .stat-card.medium { border-left-color: var(--color-medium); }
        .stat-card.low { border-left-color: var(--color-low); }
        .stat-card.closed { border-left-color: var(--color-closed); }
        .stat-number { font-size: 28px; font-weight: bold; color: var(--color-primary); }
        .stat-label { font-size: 12px; color: #aaa; margin-top: 5px; }
        .table-wrapper { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 4px; overflow: hidden; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: rgba(0, 0, 0, 0.3); border-bottom: 2px solid var(--color-border); }
        th { padding: 12px; text-align: left; font-weight: 600; font-size: 12px; color: var(--color-primary); text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 12px; border-bottom: 1px solid var(--color-border); font-size: 13px; }
        tbody tr:hover { background: rgba(50, 184, 198, 0.05); }
        .severity-badge { display: inline-block; padding: 4px 8px; border-radius: 3px; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .severity-badge.critical { background: var(--color-critical); color: white; }
        .severity-badge.high { background: var(--color-high); color: white; }
        .severity-badge.medium { background: var(--color-medium); color: #000; }
        .severity-badge.low { background: var(--color-low); color: white; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 3px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-badge.investigating { background: rgba(230, 122, 31, 0.3); color: var(--color-high); }
        .status-badge.closed { background: rgba(100, 116, 139, 0.3); color: #94a3b8; }
        .module-badge { display: inline-block; padding: 4px 8px; border-radius: 3px; font-size: 11px; background: rgba(50, 184, 198, 0.2); color: var(--color-primary); font-weight: 500; }
        .actions { display: flex; gap: 5px; flex-wrap: wrap; }
        .action-btn { padding: 4px 8px; font-size: 11px; background: transparent; border: 1px solid var(--color-primary); color: var(--color-primary); border-radius: 3px; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
        .action-btn:hover { background: rgba(50, 184, 198, 0.2); }
        .action-btn.danger { border-color: var(--color-critical); color: var(--color-critical); }
        .action-btn.danger:hover { background: rgba(192, 21, 47, 0.2); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 4px; padding: 25px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { font-size: 18px; font-weight: 600; color: var(--color-primary); margin-bottom: 20px; border-bottom: 1px solid var(--color-border); padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 12px; font-weight: 600; color: #ddd; }
        textarea { width: 100%; min-height: 100px; padding: 10px; border: 1px solid var(--color-border); background: var(--color-bg); color: var(--color-text); border-radius: 4px; resize: vertical; font-family: "Segoe UI", sans-serif; }
        textarea:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 8px rgba(50, 184, 198, 0.2); }
        .modal-footer { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; padding-top: 15px; border-top: 1px solid var(--color-border); }
        .known-issues { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
        .issue-card { background: var(--color-surface); border: 1px solid var(--color-border); border-left: 4px solid var(--color-primary); border-radius: 4px; padding: 15px; }
        .issue-card h3 { font-size: 13px; color: var(--color-primary); margin-bottom: 8px; }
        .issue-card p { font-size: 12px; color: #ccc; margin-bottom: 8px; line-height: 1.5; }
        .issue-card .tag { display: inline-block; padding: 3px 6px; background: rgba(50, 184, 198, 0.2); color: var(--color-primary); border-radius: 3px; font-size: 11px; margin-right: 5px; }
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--color-border); flex-wrap: wrap; }
        .tab-btn { padding: 10px 15px; background: transparent; border: none; color: #999; font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s ease; font-size: 13px; white-space: nowrap; }
        .tab-btn.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .empty-state { text-align: center; padding: 40px; color: #999; font-size: 14px; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px; }
        .chart-container { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 4px; padding: 20px; }
        .chart-container h3 { color: var(--color-primary); margin-bottom: 15px; font-size: 14px; }
        .comments-section { background: rgba(50, 184, 198, 0.05); border-left: 3px solid var(--color-primary); padding: 12px; border-radius: 4px; margin-top: 12px; }
        .comment { background: var(--color-bg); border: 1px solid var(--color-border); border-radius: 4px; padding: 10px; margin-bottom: 8px; font-size: 12px; }
        .comment-time { color: #999; font-size: 11px; margin-bottom: 4px; }
        .comment-text { color: #ddd; word-wrap: break-word; }
        .form-section { margin-bottom: 20px; border-bottom: 1px solid var(--color-border); padding-bottom: 15px; }
        .form-section:last-child { border-bottom: none; }
        .form-section h4 { color: var(--color-primary); font-size: 13px; margin-bottom: 10px; }
        .audit-entry { background: var(--color-surface); border: 1px solid var(--color-border); padding: 12px; margin-bottom: 10px; border-radius: 4px; }
        .audit-timestamp { color: var(--color-primary); font-weight: 600; font-size: 12px; }
        .audit-action { color: #ff6b6b; font-weight: 600; margin-top: 4px; }
        .audit-details { color: #ccc; font-size: 12px; margin-top: 6px; line-height: 1.4; }
        .password-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 2000; align-items: center; justify-content: center; }
        .password-modal.active { display: flex; }
        .password-modal-content { background: var(--color-surface); border: 2px solid var(--color-critical); border-radius: 4px; padding: 25px; max-width: 400px; width: 90%; text-align: center; }
        .password-modal-content h3 { color: var(--color-critical); margin-bottom: 15px; font-size: 16px; }
        .password-modal-content p { color: #ccc; margin-bottom: 15px; font-size: 12px; }
        .password-modal-content input { width: 100%; margin-bottom: 15px; }
        .detail-field { margin-bottom: 15px; }
        .detail-label { color: var(--color-primary); font-weight: 600; font-size: 12px; margin-bottom: 5px; }
        .detail-value { color: #ddd; font-size: 13px; word-wrap: break-word; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 3px; }
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            header { flex-direction: column; gap: 10px; }
            .header-right { width: 100%; justify-content: space-between; flex-wrap: wrap; }
            table { font-size: 12px; }
            th, td { padding: 8px; }
            .stats { grid-template-columns: repeat(2, 1fr); }
            .tab-buttons { flex-wrap: wrap; }
            .actions { flex-direction: column; }
            .action-btn { width: 100%; text-align: center; }
            .modal-content { max-width: 95%; padding: 15px; }
            .login-box { padding: 25px; max-width: 90%; }
            .login-box h1 { font-size: 22px; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>Sirius Hypercare</h1>
            <p>Programme Sirius - Hypercare Support Portal</p>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group-login">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" placeholder="your.email@altayer.com" required>
                </div>
                <div class="form-group-login">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="login-btn">Sign In</button>
                <div id="loginError" class="login-error"></div>
            </form>
        </div>
    </div>

    <!-- Main App (Hidden Until Logged In) -->
    <div id="mainApp" class="hidden">
        <header>
            <div class="header-left">
                <div>
                    <h1>Programme Sirius - Hypercare Support</h1>
                    <p id="currentDate"></p>
                </div>
            </div>
            <div class="header-right">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>Live Tracking</span>
                </div>
                <div class="user-info">
                    <span>Logged in as: <strong id="userEmail"></strong></span>
                </div>
                <div class="last-update">
                    Last Updated: <span id="lastUpdate">--:--</span>
                </div>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
        </header>

        <div class="container">
            <div class="stats">
                <div class="stat-card total">
                    <div class="stat-number" id="countTotal">0</div>
                    <div class="stat-label">Total Open Issues</div>
                </div>
                <div class="stat-card critical">
                    <div class="stat-number" id="countCritical">0</div>
                    <div class="stat-label">CRITICAL</div>
                </div>
                <div class="stat-card high">
                    <div class="stat-number" id="countHigh">0</div>
                    <div class="stat-label">HIGH Priority</div>
                </div>
                <div class="stat-card medium">
                    <div class="stat-number" id="countMedium">0</div>
                    <div class="stat-label">MEDIUM</div>
                </div>
                <div class="stat-card low">
                    <div class="stat-number" id="countLow">0</div>
                    <div class="stat-label">LOW</div>
                </div>
                <div class="stat-card closed">
                    <div class="stat-number" id="countClosed">0</div>
                    <div class="stat-label">CLOSED</div>
                </div>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab(event, 'active-issues')">Active Issues</button>
                <button class="tab-btn" onclick="switchTab(event, 'charts')">Charts &amp; Analytics</button>
                <button class="tab-btn" onclick="switchTab(event, 'training-issues')">Training Issues</button>
                <button class="tab-btn" onclick="switchTab(event, 'known-issues')">Known Issues &amp; Workarounds</button>
                <button class="tab-btn" onclick="switchTab(event, 'shift-log')">Shift Log &amp; Handover</button>
                <button class="tab-btn" onclick="switchTab(event, 'audit-log')">Audit Log</button>
            </div>

            <div id="active-issues" class="tab-content active">
                <div class="controls">
                    <input type="text" id="searchInput" placeholder="Search by module, process, or ticket ID..." onkeyup="updateTable()">
                    <select id="severityFilter" onchange="updateTable()">
                        <option value="">All Severities</option>
                        <option value="Critical">Critical</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                    <select id="statusFilter" onchange="updateTable()">
                        <option value="">All Status</option>
                        <option value="Investigating">Investigating</option>
                        <option value="Closed">Closed</option>
                    </select>
                    <button onclick="openNewIssueModal()">+ Log New Issue</button>
                    <button class="secondary" onclick="downloadCSV()">Export</button>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Ticket ID</th>
                                <th>Module</th>
                                <th>Process</th>
                                <th>Severity</th>
                                <th>Status</th>
                                <th>Owner</th>
                                <th>Time Logged</th>
                                <th>Duration Open</th>
                                <th>Reopens</th>
                                <th>Training</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="issuesTable"></tbody>
                    </table>
                </div>
                <div id="emptyState" class="empty-state" style="display: none;">No issues logged. Great work team!</div>
            </div>

            <div id="charts" class="tab-content">
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>Issues by Severity</h3>
                        <div id="severityChart" style="color:#ddd;font-size:13px;padding:20px;text-align:center;"></div>
                    </div>
                    <div class="chart-container">
                        <h3>Issues by Status</h3>
                        <div id="statusChart" style="color:#ddd;font-size:13px;padding:20px;text-align:center;"></div>
                    </div>
                    <div class="chart-container">
                        <h3>Issues by Module</h3>
                        <div id="moduleChart" style="color:#ddd;font-size:13px;padding:20px;text-align:center;"></div>
                    </div>
                    <div class="chart-container">
                        <h3>Reopened Issues</h3>
                        <div id="reopenChart" style="color:#ddd;font-size:13px;padding:20px;text-align:center;"></div>
                    </div>
                </div>
            </div>

            <div id="training-issues" class="tab-content">
                <div class="controls">
                    <button onclick="filterTrainingIssues()">Refresh Training View</button>
                    <button class="secondary" onclick="downloadTrainingCSV()">Export Training Report</button>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Ticket ID</th>
                                <th>Module</th>
                                <th>Process</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Owner</th>
                            </tr>
                        </thead>
                        <tbody id="trainingIssuesTable"></tbody>
                    </table>
                </div>
                <div id="trainingEmpty" class="empty-state" style="display: none;">No training-related issues logged.</div>
            </div>

            <div id="known-issues" class="tab-content">
                <div class="controls">
                    <button onclick="openKnownIssueModal()">+ Add Known Issue</button>
                </div>
                <div class="known-issues" id="knownIssuesContainer"></div>
            </div>

            <div id="shift-log" class="tab-content">
                <div class="controls">
                    <button onclick="openShiftLogModal()">+ Add Shift Handover Note</button>
                </div>
                <div id="shiftLogContainer" style="max-height: 600px; overflow-y: auto;"></div>
            </div>

            <div id="audit-log" class="tab-content">
                <div class="controls">
                    <button class="secondary" onclick="downloadAuditLog()">Export Audit Log</button>
                    <button class="secondary" onclick="openClearAuditModal()">Clear Audit Log</button>
                </div>
                <div id="auditLogContainer" style="max-height: 700px; overflow-y: auto;"></div>
                <div id="auditEmpty" class="empty-state" style="display: none;">No audit records yet.</div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="newIssueModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Log New Issue</div>
            <form onsubmit="saveNewIssue(event)">
                <div class="form-group">
                    <label>SAP Rise S/4HANA Module *</label>
                    <select id="issueModule" required>
                        <option value="">Select Module</option>
                        <option value="FI">Financial (SAP S/4HANA FI)</option>
                        <option value="CO">Controlling (SAP S/4HANA CO)</option>
                        <option value="MM">Materials Management (SAP S/4HANA MM)</option>
                        <option value="PP">Production Planning (SAP S/4HANA PP)</option>
                        <option value="SD">Sales &amp; Distribution (SAP S/4HANA SD)</option>
                        <option value="HCM">Human Capital Management (SAP SuccessFactors)</option>
                        <option value="PM">Plant Maintenance (SAP S/4HANA PM)</option>
                        <option value="Integration">SAP Integration Suite (RISE)</option>
                        <option value="Analytics">SAP Analytics Cloud</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Process / Transaction *</label>
                    <input type="text" id="issueProcess" placeholder="e.g., AP Invoice Processing" required>
                </div>
                <div class="form-group">
                    <label>Severity *</label>
                    <select id="issueSeverity" required>
                        <option value="">Select Severity</option>
                        <option value="Critical">CRITICAL (Blocks production)</option>
                        <option value="High">HIGH (Significant impact)</option>
                        <option value="Medium">MEDIUM (Workaround exists)</option>
                        <option value="Low">LOW (Minor, non-blocking)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Environment *</label>
                    <select id="issueEnv" required>
                        <option value="">Select Environment</option>
                        <option value="Production">Production</option>
                        <option value="UAT">UAT</option>
                        <option value="Dev">Dev</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Impacted Business Unit(s)</label>
                    <input type="text" id="issueImpactBU" placeholder="e.g., Treasury, Retail Banking">
                </div>
                <div class="form-group">
                    <label>Issue Description / Error Message *</label>
                    <textarea id="issueDescription" placeholder="Describe the issue..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Assigned Owner *</label>
                    <input type="text" id="issueOwner" placeholder="Name (Role)" required>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="issueTraining" style="width: auto; cursor: pointer;">
                        <span>Is this a Training-Related Issue?</span>
                    </label>
                </div>
                <div class="modal-footer">
                    <button type="button" class="secondary" onclick="closeModal('newIssueModal')">Cancel</button>
                    <button type="submit">Log Issue</button>
                </div>
            </form>
        </div>
    </div>

    <div id="viewIssueModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Issue Details - <span id="viewTicketId"></span></div>
            <div id="viewIssueContent"></div>
            <div class="modal-footer">
                <button type="button" class="secondary" onclick="closeModal('viewIssueModal')">Close</button>
            </div>
        </div>
    </div>

    <div id="knownIssueModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Add Known Issue / Workaround</div>
            <form onsubmit="saveKnownIssue(event)">
                <div class="form-group">
                    <label>Issue Title *</label>
                    <input type="text" id="knownTitle" placeholder="Brief title" required>
                </div>
                <div class="form-group">
                    <label>Root Cause / Description *</label>
                    <textarea id="knownDesc" placeholder="Explain the root cause..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Workaround / Solution *</label>
                    <textarea id="knownWorkaround" placeholder="Step-by-step workaround..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Applies To (Module / BU)</label>
                    <input type="text" id="knownAppliesTo" placeholder="e.g., FI, SD, All">
                </div>
                <div class="modal-footer">
                    <button type="button" class="secondary" onclick="closeModal('knownIssueModal')">Cancel</button>
                    <button type="submit">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editIssueModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">Edit Issue &amp; Add Progress Comments</div>
            <form onsubmit="saveEditedIssue(event)">
                <div class="form-section">
                    <h4>Issue Details</h4>
                    <div class="form-group">
                        <label>Ticket ID (Read-only)</label>
                        <input type="text" id="editTicketId" readonly style="opacity: 0.6;">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="editStatus">
                            <option value="Investigating">Investigating</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description *</label>
                        <textarea id="editDescription" placeholder="Update description..." required></textarea>
                    </div>
                </div>
                <div class="form-section">
                    <h4>Add Progress Comment / Real-time Update</h4>
                    <div class="form-group">
                        <label>Progress Update *</label>
                        <textarea id="editComment" placeholder="Add progress update..." required style="min-height: 80px;"></textarea>
                    </div>
                </div>
                <div class="form-section">
                    <h4>Comments History</h4>
                    <div id="editCommentsHistory" class="comments-section" style="max-height: 200px; overflow-y: auto;">
                        <p style="color: #999; font-size: 12px;">No comments yet</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="secondary" onclick="closeModal('editIssueModal')">Cancel</button>
                    <button type="submit">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="shiftLogModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Shift Handover Note</div>
            <form onsubmit="saveShiftLog(event)">
                <div class="form-group">
                    <label>Shift (From - To) *</label>
                    <input type="text" id="shiftTime" placeholder="e.g., 06:00 - 14:00" required>
                </div>
                <div class="form-group">
                    <label>Handover Lead *</label>
                    <input type="text" id="shiftLead" placeholder="Name &amp; Role" required>
                </div>
                <div class="form-group">
                    <label>Key Achievements / Resolved Issues</label>
                    <textarea id="shiftAchievements" placeholder="List of resolved issues..."></textarea>
                </div>
                <div class="form-group">
                    <label>Open Items &amp; Pending Actions *</label>
                    <textarea id="shiftPending" placeholder="Critical items still being worked on..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Resource Notes</label>
                    <textarea id="shiftResources" placeholder="Team absences, tool issues..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="secondary" onclick="closeModal('shiftLogModal')">Cancel</button>
                    <button type="submit">Save Handover</button>
                </div>
            </form>
        </div>
    </div>

    <div id="deletePasswordModal" class="password-modal">
        <div class="password-modal-content">
            <h3>Delete Ticket - Security Verification</h3>
            <p>Ticket deletion requires password authorization. This action cannot be undone.</p>
            <input type="password" id="deletePassword" placeholder="Enter password">
            <div class="modal-footer">
                <button type="button" class="secondary" onclick="cancelDelete()">Cancel</button>
                <button type="button" onclick="confirmDelete()">Delete Ticket</button>
            </div>
        </div>
    </div>

    <div id="clearAuditModal" class="password-modal">
        <div class="password-modal-content">
            <h3>Clear Audit Log - Security Verification</h3>
            <p>Clearing audit log requires password authorization. This action cannot be undone.</p>
            <input type="password" id="clearAuditPassword" placeholder="Enter password">
            <div class="modal-footer">
                <button type="button" class="secondary" onclick="cancelClearAudit()">Cancel</button>
                <button type="button" onclick="confirmClearAudit()">Clear Audit Log</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase init
        const firebaseConfig = {
            apiKey: "AIzaSyCH7faPA_RpNYYEIcQWgqd5fVwPKMm4z0M",
            authDomain: "sirius-hypercare.firebaseapp.com",
            projectId: "sirius-hypercare",
            storageBucket: "sirius-hypercare.firebasestorage.app",
            messagingSenderId: "74660895964",
            appId: "1:74660895964:web:50a845cdedf2d79e742819"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let issues = [];
        let knownIssues = [];
        let shiftLogs = [];
        let auditLog = [];
        let pendingDeleteIssueId = null;
        let currentUser = null;

        // Auth state listener
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email;
                startListeners();
            } else {
                currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';
                    errorDiv.textContent = '';
                })
                .catch(err => {
                    errorDiv.textContent = 'Login failed: ' + err.message;
                });
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut().then(() => {
                    console.log('Logged out successfully');
                }).catch(err => alert('Logout failed: ' + err.message));
            }
        }

        function startListeners() {
            // Real-time listeners
            db.collection('issues').orderBy('logTime', 'desc').onSnapshot(snap => {
                issues = [];
                snap.forEach(doc => issues.push({ id: doc.id, ...doc.data() }));
                updateTable();
                updateCharts();
                filterTrainingIssues();
                updateStats();
            });

            db.collection('knownIssues').onSnapshot(snap => {
                knownIssues = [];
                snap.forEach(doc => knownIssues.push({ id: doc.id, ...doc.data() }));
                renderKnownIssues();
            });

            db.collection('shiftLogs').orderBy('timestamp', 'desc').onSnapshot(snap => {
                shiftLogs = [];
                snap.forEach(doc => shiftLogs.push({ id: doc.id, ...doc.data() }));
                renderShiftLogs();
            });

            db.collection('auditLog').orderBy('timestamp', 'desc').onSnapshot(snap => {
                auditLog = [];
                snap.forEach(doc => auditLog.push({ id: doc.id, ...doc.data() }));
                renderAuditLog();
            });

            updateDate();
            setInterval(updateLastUpdate, 60000);
            updateLastUpdate();
        }

        function updateDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', options);
        }

        function updateLastUpdate() {
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('lastUpdate').textContent = time;
        }

        function switchTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        async function getNextSRNumber() {
            const configRef = db.collection('config').doc('settings');
            const doc = await configRef.get();
            let nextNum = 1;
            if (doc.exists) {
                nextNum = (doc.data().nextSRNumber || 0) + 1;
            }
            await configRef.set({ nextSRNumber: nextNum }, { merge: true });
            return 'SR' + String(nextNum).padStart(3, '0');
        }

        function updateTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const severityFilter = document.getElementById('severityFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            let filtered = issues.filter(issue => {
                const matchSearch = searchTerm === '' || issue.id.toLowerCase().includes(searchTerm) || issue.module.toLowerCase().includes(searchTerm) || issue.process.toLowerCase().includes(searchTerm);
                const matchSeverity = severityFilter === '' || issue.severity === severityFilter;
                const matchStatus = statusFilter === '' || issue.status === statusFilter;
                return matchSearch && matchSeverity && matchStatus;
            });

            const tableBody = document.getElementById('issuesTable');
            tableBody.innerHTML = '';

            if (filtered.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
            } else {
                document.getElementById('emptyState').style.display = 'none';
                filtered.forEach(issue => {
                    const row = document.createElement('tr');
                    const logTime = issue.logTime && issue.logTime.toDate ? issue.logTime.toDate() : new Date(issue.logTime);
                    row.innerHTML = `<td><strong>${issue.id}</strong></td><td><span class="module-badge">${issue.module}</span></td><td>${issue.process}</td><td><span class="severity-badge ${issue.severity.toLowerCase()}">${issue.severity}</span></td><td><span class="status-badge ${issue.status.toLowerCase()}">${issue.status}</span></td><td>${issue.owner}</td><td>${logTime.toLocaleString()}</td><td style="text-align: center; font-size: 12px; color: #32b8c6; font-weight: 600;">${calculateDuration(logTime, issue.closedTime)}</td><td style="text-align: center; font-weight: 600;">${issue.reopens || 0}</td><td style="text-align: center;">${issue.isTraining ? 'YES' : 'NO'}</td><td><div class="actions"><button class="action-btn" onclick="viewIssue('${issue.id}')">View</button><button class="action-btn" onclick="editIssue('${issue.id}')">Edit</button>${issue.status === 'Closed' ? `<button class="action-btn" onclick="reopenIssue('${issue.id}')">Re-open</button>` : `<button class="action-btn danger" onclick="closeIssue('${issue.id}')">Close</button>`}<button class="action-btn danger" onclick="initiateDeleteTicket('${issue.id}')">Delete</button></div></td>`;
                    tableBody.appendChild(row);
                });
            }
            updateStats();
        }

        function viewIssue(issueId) {
            const issue = issues.find(i => i.id === issueId);
            if (!issue) return;

            const logTime = issue.logTime && issue.logTime.toDate ? issue.logTime.toDate() : new Date(issue.logTime);
            const closedTime = issue.closedTime && issue.closedTime.toDate ? issue.closedTime.toDate() : null;

            let html = `
                <div class="detail-field">
                    <div class="detail-label">Module</div>
                    <div class="detail-value">${issue.module}</div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Process</div>
                    <div class="detail-value">${issue.process}</div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Severity</div>
                    <div class="detail-value"><span class="severity-badge ${issue.severity.toLowerCase()}">${issue.severity}</span></div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Status</div>
                    <div class="detail-value"><span class="status-badge ${issue.status.toLowerCase()}">${issue.status}</span></div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Owner</div>
                    <div class="detail-value">${issue.owner}</div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Environment</div>
                    <div class="detail-value">${issue.env}</div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Impacted Business Unit(s)</div>
                    <div class="detail-value">${issue.impactBU || 'N/A'}</div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Time Logged</div>
                    <div class="detail-value">${logTime.toLocaleString()}</div>
                </div>
                ${closedTime ? `<div class="detail-field">
                    <div class="detail-label">Time Closed</div>
                    <div class="detail-value">${closedTime.toLocaleString()}</div>
                </div>` : ''}
                <div class="detail-field">
                    <div class="detail-label">Duration Open</div>
                    <div class="detail-value">${calculateDuration(logTime, closedTime)}</div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Reopens</div>
                    <div class="detail-value">${issue.reopens || 0}</div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Training-Related</div>
                    <div class="detail-value">${issue.isTraining ? 'Yes' : 'No'}</div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Description</div>
                    <div class="detail-value">${issue.description}</div>
                </div>
            `;

            if (issue.comments && issue.comments.length > 0) {
                html += '<div class="detail-field"><div class="detail-label">Comments</div><div class="comments-section">';
                issue.comments.forEach(c => {
                    const cTime = c.time && c.time.toDate ? c.time.toDate() : new Date(c.time);
                    html += `<div class="comment"><div class="comment-time">${cTime.toLocaleString()}</div><div class="comment-text">${c.text}</div></div>`;
                });
                html += '</div></div>';
            }

            document.getElementById('viewTicketId').textContent = issue.id;
            document.getElementById('viewIssueContent').innerHTML = html;
            document.getElementById('viewIssueModal').classList.add('active');
        }

        function updateStats() {
            const openIssues = issues.filter(i => i.status !== 'Closed').length;
            document.getElementById('countTotal').textContent = openIssues;
            document.getElementById('countCritical').textContent = issues.filter(i => i.severity === 'Critical' && i.status !== 'Closed').length;
            document.getElementById('countHigh').textContent = issues.filter(i => i.severity === 'High' && i.status !== 'Closed').length;
            document.getElementById('countMedium').textContent = issues.filter(i => i.severity === 'Medium' && i.status !== 'Closed').length;
            document.getElementById('countLow').textContent = issues.filter(i => i.severity === 'Low' && i.status !== 'Closed').length;
            document.getElementById('countClosed').textContent = issues.filter(i => i.status === 'Closed').length;
        }

        function calculateDuration(logTime, closedTime) {
            if (!logTime) return '--';
            const now = closedTime ? (closedTime instanceof Date ? closedTime : closedTime.toDate()) : new Date();
            const start = logTime instanceof Date ? logTime : logTime.toDate();
            const diffMs = now - start;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            if (diffDays > 0) return diffDays + 'd ' + (diffHours % 24) + 'h';
            return diffHours + 'h';
        }

        function updateCharts() {
            const severityChart = document.getElementById('severityChart');
            const statusChart = document.getElementById('statusChart');
            const moduleChart = document.getElementById('moduleChart');
            
            const severityCounts = {};
            const statusCounts = {};
            const moduleCounts = {};
            
            issues.forEach(issue => {
                severityCounts[issue.severity] = (severityCounts[issue.severity] || 0) + 1;
                statusCounts[issue.status] = (statusCounts[issue.status] || 0) + 1;
                moduleCounts[issue.module] = (moduleCounts[issue.module] || 0) + 1;
            });

            severityChart.innerHTML = '<strong>Severity Distribution:</strong><br>' + Object.entries(severityCounts).map(([k, v]) => k + ': ' + v).join('<br>');
            statusChart.innerHTML = '<strong>Status Distribution:</strong><br>' + Object.entries(statusCounts).map(([k, v]) => k + ': ' + v).join('<br>');
            moduleChart.innerHTML = '<strong>Module Distribution:</strong><br>' + Object.entries(moduleCounts).map(([k, v]) => k + ': ' + v).join('<br>');
        }

        function filterTrainingIssues() {
            const trainingIssues = issues.filter(i => i.isTraining);
            const tableBody = document.getElementById('trainingIssuesTable');
            tableBody.innerHTML = '';

            if (trainingIssues.length === 0) {
                document.getElementById('trainingEmpty').style.display = 'block';
            } else {
                document.getElementById('trainingEmpty').style.display = 'none';
                trainingIssues.forEach(issue => {
                    const row = document.createElement('tr');
                    const logTime = issue.logTime && issue.logTime.toDate ? issue.logTime.toDate() : new Date(issue.logTime);
                    row.innerHTML = `<td><strong>${issue.id}</strong></td><td><span class="module-badge">${issue.module}</span></td><td>${issue.process}</td><td>${issue.description}</td><td><span class="status-badge ${issue.status.toLowerCase()}">${issue.status}</span></td><td>${issue.owner}</td>`;
                    tableBody.appendChild(row);
                });
            }
        }

        function renderKnownIssues() {
            const container = document.getElementById('knownIssuesContainer');
            container.innerHTML = '';
            knownIssues.forEach(issue => {
                const card = document.createElement('div');
                card.className = 'issue-card';
                card.innerHTML = `<h3>${issue.title}</h3><p><strong>Root Cause:</strong> ${issue.desc}</p><p><strong>Workaround:</strong> ${issue.workaround}</p><div><span class="tag">${issue.appliesTo}</span><button class="action-btn" style="margin-top: 10px;" onclick="deleteKnownIssue('${issue.id}')">Delete</button></div>`;
                container.appendChild(card);
            });
        }

        function renderShiftLogs() {
            const container = document.getElementById('shiftLogContainer');
            container.innerHTML = '';
            shiftLogs.forEach(log => {
                const card = document.createElement('div');
                card.style.cssText = 'background: var(--color-surface); border: 1px solid var(--color-border); padding: 15px; margin-bottom: 10px; border-radius: 4px;';
                const timestamp = log.timestamp && log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                card.innerHTML = '<p><strong>Shift:</strong> ' + log.time + '</p><p><strong>Handover Lead:</strong> ' + log.lead + '</p><p><strong>Logged at:</strong> ' + timestamp.toLocaleString() + '</p>' + (log.achievements ? '<p><strong>Achievements:</strong> ' + log.achievements + '</p>' : '') + (log.pending ? '<p><strong>Pending:</strong> ' + log.pending + '</p>' : '') + (log.resources ? '<p><strong>Resources:</strong> ' + log.resources + '</p>' : '');
                container.appendChild(card);
            });
        }

        function renderAuditLog() {
            const container = document.getElementById('auditLogContainer');
            container.innerHTML = '';
            if (auditLog.length === 0) {
                document.getElementById('auditEmpty').style.display = 'block';
            } else {
                document.getElementById('auditEmpty').style.display = 'none';
                auditLog.forEach(entry => {
                    const card = document.createElement('div');
                    card.className = 'audit-entry';
                    const timestamp = entry.timestamp && entry.timestamp.toDate ? entry.timestamp.toDate() : new Date(entry.timestamp);
                    card.innerHTML = '<div class="audit-timestamp">' + timestamp.toLocaleString() + '</div><div class="audit-action">' + entry.action + '</div><div class="audit-details">' + entry.details + '</div>';
                    container.appendChild(card);
                });
            }
        }

        function openNewIssueModal() { document.getElementById('newIssueModal').classList.add('active'); }
        function openKnownIssueModal() { document.getElementById('knownIssueModal').classList.add('active'); }
        function openShiftLogModal() { document.getElementById('shiftLogModal').classList.add('active'); }
        function openClearAuditModal() { document.getElementById('clearAuditModal').classList.add('active'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); }

        async function saveNewIssue(event) {
            event.preventDefault();
            const ticketId = await getNextSRNumber();
            const now = new Date();

            const issue = {
                id: ticketId,
                module: document.getElementById('issueModule').value,
                process: document.getElementById('issueProcess').value,
                severity: document.getElementById('issueSeverity').value,
                status: 'Investigating',
                owner: document.getElementById('issueOwner').value,
                logTime: firebase.firestore.Timestamp.fromDate(now),
                description: document.getElementById('issueDescription').value,
                env: document.getElementById('issueEnv').value,
                impactBU: document.getElementById('issueImpactBU').value,
                isTraining: document.getElementById('issueTraining').checked,
                reopens: 0,
                reopenHistory: [],
                closedTime: null,
                comments: []
            };

            db.collection('issues').doc(ticketId).set(issue)
                .then(() => {
                    closeModal('newIssueModal');
                    event.target.reset();
                    alert('Issue ' + ticketId + ' logged successfully!');
                    addAuditEntry('CREATE', 'Issue ' + ticketId + ' created by ' + issue.owner);
                })
                .catch(err => alert('Failed to log issue: ' + err.message));
        }

        function saveKnownIssue(event) {
            event.preventDefault();
            const id = 'KI-' + String(Date.now());

            const issue = {
                title: document.getElementById('knownTitle').value,
                desc: document.getElementById('knownDesc').value,
                workaround: document.getElementById('knownWorkaround').value,
                appliesTo: document.getElementById('knownAppliesTo').value || 'General'
            };

            db.collection('knownIssues').doc(id).set(issue)
                .then(() => {
                    closeModal('knownIssueModal');
                    event.target.reset();
                    alert('Known issue added!');
                    addAuditEntry('CREATE_KNOWN', 'Known issue added: ' + issue.title);
                })
                .catch(err => alert('Failed to save: ' + err.message));
        }

        function saveShiftLog(event) {
            event.preventDefault();
            const id = 'SL-' + String(Date.now());
            const now = new Date();

            const log = {
                time: document.getElementById('shiftTime').value,
                lead: document.getElementById('shiftLead').value,
                achievements: document.getElementById('shiftAchievements').value,
                pending: document.getElementById('shiftPending').value,
                resources: document.getElementById('shiftResources').value,
                timestamp: firebase.firestore.Timestamp.fromDate(now)
            };

            db.collection('shiftLogs').doc(id).set(log)
                .then(() => {
                    closeModal('shiftLogModal');
                    event.target.reset();
                    alert('Shift handover logged!');
                    addAuditEntry('SHIFT_LOG', 'Shift handover by ' + log.lead);
                })
                .catch(err => alert('Failed to save: ' + err.message));
        }

        function saveEditedIssue(event) {
            event.preventDefault();
            const id = document.getElementById('editTicketId').value;
            const status = document.getElementById('editStatus').value;
            const description = document.getElementById('editDescription').value;
            const commentText = document.getElementById('editComment').value;
            const now = new Date();

            const updates = { status, description };

            if (commentText.trim()) {
                const comment = { time: firebase.firestore.Timestamp.fromDate(now), text: commentText };
                updates.comments = firebase.firestore.FieldValue.arrayUnion(comment);
            }

            db.collection('issues').doc(id).update(updates)
                .then(() => {
                    closeModal('editIssueModal');
                    event.target.reset();
                    addAuditEntry('EDIT', 'Issue ' + id + ' updated');
                })
                .catch(err => alert('Failed to update: ' + err.message));
        }

        function editIssue(issueId) {
            const issue = issues.find(i => i.id === issueId);
            if (!issue) return;

            document.getElementById('editTicketId').value = issue.id;
            document.getElementById('editStatus').value = issue.status;
            document.getElementById('editDescription').value = issue.description;
            document.getElementById('editComment').value = '';

            let commentsHtml = '';
            if (issue.comments && issue.comments.length > 0) {
                commentsHtml = issue.comments.map(c => {
                    const cTime = c.time && c.time.toDate ? c.time.toDate() : new Date(c.time);
                    return '<div class="comment"><div class="comment-time">' + cTime.toLocaleString() + '</div><div class="comment-text">' + c.text + '</div></div>';
                }).join('');
            }
            document.getElementById('editCommentsHistory').innerHTML = commentsHtml || '<p style="color: #999; font-size: 12px;">No comments yet</p>';

            document.getElementById('editIssueModal').classList.add('active');
        }

        function closeIssue(issueId) {
            const now = new Date();
            db.collection('issues').doc(issueId).update({
                status: 'Closed',
                closedTime: firebase.firestore.Timestamp.fromDate(now)
            }).then(() => {
                addAuditEntry('CLOSE', 'Issue ' + issueId + ' closed');
            }).catch(err => alert('Failed: ' + err.message));
        }

        function reopenIssue(issueId) {
            const now = new Date();
            db.collection('issues').doc(issueId).update({
                status: 'Investigating',
                closedTime: null,
                reopens: firebase.firestore.FieldValue.increment(1),
                reopenHistory: firebase.firestore.FieldValue.arrayUnion(firebase.firestore.Timestamp.fromDate(now))
            }).then(() => {
                addAuditEntry('REOPEN', 'Issue ' + issueId + ' reopened');
            }).catch(err => alert('Failed: ' + err.message));
        }

        function initiateDeleteTicket(issueId) {
            pendingDeleteIssueId = issueId;
            document.getElementById('deletePasswordModal').classList.add('active');
        }

        function cancelDelete() {
            document.getElementById('deletePassword').value = '';
            document.getElementById('deletePasswordModal').classList.remove('active');
            pendingDeleteIssueId = null;
        }

        function confirmDelete() {
            const password = document.getElementById('deletePassword').value;
            if (password !== 'admin123') {
                alert('Incorrect password');
                return;
            }

            const issueId = pendingDeleteIssueId;
            db.collection('issues').doc(issueId).delete()
                .then(() => {
                    document.getElementById('deletePassword').value = '';
                    document.getElementById('deletePasswordModal').classList.remove('active');
                    pendingDeleteIssueId = null;
                    addAuditEntry('DELETE', 'Issue ' + issueId + ' deleted');
                })
                .catch(err => alert('Failed: ' + err.message));
        }

        function deleteKnownIssue(knownIssueId) {
            if (confirm('Delete this known issue?')) {
                db.collection('knownIssues').doc(knownIssueId).delete()
                    .then(() => addAuditEntry('DELETE_KNOWN', 'Known issue deleted'))
                    .catch(err => alert('Failed: ' + err.message));
            }
        }

        function cancelClearAudit() {
            document.getElementById('clearAuditPassword').value = '';
            document.getElementById('clearAuditModal').classList.remove('active');
        }

        function confirmClearAudit() {
            const password = document.getElementById('clearAuditPassword').value;
            if (password !== 'admin123') {
                alert('Incorrect password');
                return;
            }

            db.collection('auditLog').get().then(snap => {
                const batch = db.batch();
                snap.forEach(doc => batch.delete(doc.ref));
                return batch.commit();
            }).then(() => {
                document.getElementById('clearAuditPassword').value = '';
                document.getElementById('clearAuditModal').classList.remove('active');
                alert('Audit log cleared!');
            }).catch(err => alert('Failed: ' + err.message));
        }

        function addAuditEntry(action, details) {
            const id = 'AL-' + String(Date.now());
            const now = new Date();
            const entry = {
                timestamp: firebase.firestore.Timestamp.fromDate(now),
                action,
                details
            };
            db.collection('auditLog').doc(id).set(entry).catch(() => {});
        }

        function downloadCSV() {
            let csv = 'Ticket ID,Module,Process,Severity,Status,Owner,Time Logged\n';
            issues.forEach(issue => {
                const logTime = issue.logTime && issue.logTime.toDate ? issue.logTime.toDate() : new Date(issue.logTime);
                csv += '"' + issue.id + '","' + issue.module + '","' + issue.process + '","' + issue.severity + '","' + issue.status + '","' + issue.owner + '","' + logTime.toLocaleString() + '"\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sirius-issues-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        function downloadTrainingCSV() {
            const training = issues.filter(i => i.isTraining);
            let csv = 'Ticket ID,Module,Process,Description,Status,Owner\n';
            training.forEach(issue => {
                csv += '"' + issue.id + '","' + issue.module + '","' + issue.process + '","' + issue.description + '","' + issue.status + '","' + issue.owner + '"\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sirius-training-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        function downloadAuditLog() {
            let csv = 'Timestamp,Action,Details\n';
            auditLog.forEach(entry => {
                const timestamp = entry.timestamp && entry.timestamp.toDate ? entry.timestamp.toDate() : new Date(entry.timestamp);
                csv += '"' + timestamp.toLocaleString() + '","' + entry.action + '","' + entry.details + '"\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sirius-audit-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }
    </script>
</body>
</html>
